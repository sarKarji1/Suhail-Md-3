const {
  smd,
  tlang,
  prefix,
  Config,
  sleep,
  getBuffer,
  smdJson,
  smdBuffer
} = require('../lib');

const axios = require('axios');
const yts = require('yt-search');

//
// ğŸ” YouTube Search Command (yts)
//
smd({
  cmdname: "yts",
  alias: ["ytsearch", "ysearch"],
  desc: "Search YouTube and get video results",
  type: "search",
  filename: __filename,
},
async (m) => {
  try {
    let text = m.body.split(" ").slice(1).join(" ").trim();
    if (!text) return m.reply("*ğŸ” Provide a search query!*\n\nExample:\n.yts tu hai kahan");

    const search = await yts(text);
    const videos = search.videos.slice(0, 8);

    if (!videos || videos.length === 0) return m.reply("âŒ No results found!");

    let msg = `ğŸ¬ *YouTube Search Results for:* _${text}_\n\n`;

    for (let i = 0; i < videos.length; i++) {
      const v = videos[i];
      msg += `*${i + 1}. ${v.title}*\n`;
      msg += `ğŸ§‘ ${v.author.name} | â±ï¸ ${v.timestamp} | ğŸ‘ï¸ ${v.views.toLocaleString()}\n`;
      msg += `ğŸ”— ${v.url}\n\n`;
    }

    await m.reply(msg.trim());

  } catch (e) {
    m.error(`${e}\n\nCommand: yts`, e, false);
  }
});

//
// ğŸ“¦ NPM Search Command (npm)
//
smd({
  cmdname: "npm",
  alias: ["npmpkg", "npms"],
  desc: "Search NPM for a package",
  type: "search",
  filename: __filename,
},
async (m) => {
  try {
    let text = m.body.split(" ").slice(1).join(" ").trim();

    if (!text) return m.reply("*ğŸ“¦ Enter a package name to search!*\n\nExample:\n.npm axios");

    const res = await axios.get(`https://registry.npmjs.com/${encodeURIComponent(text)}`);
    const info = res.data;

    const name = info.name || text;
    const version = info["dist-tags"]?.latest || "unknown";
    const desc = info.description || "No description";
    const author = typeof info.author === "object" ? info.author.name : info.author || "Unknown";
    const homepage = `https://www.npmjs.com/package/${name}`;

    const stats = await axios.get(`https://api.npmjs.org/downloads/point/last-week/${name}`);
    const downloads = stats.data.downloads?.toLocaleString() || "N/A";

    const msg = `ğŸ“¦ *NPM Package Info*\n\n` +
      `ğŸ”¹ *Name:* ${name}\n` +
      `ğŸ”¸ *Version:* ${version}\n` +
      `ğŸ§‘ *Author:* ${author}\n` +
      `ğŸ“ *Description:* ${desc}\n` +
      `ğŸ“ˆ *Weekly Downloads:* ${downloads}\n` +
      `ğŸŒ *Link:* ${homepage}`;

    await m.reply(msg);

  } catch (e) {
    if (e?.response?.status === 404) {
      return m.reply("âŒ Package not found on NPM.");
    }
    m.error(`${e}\n\nCommand: npm`, e, false);
  }
});
