const {
  smd,
  tlang,
  prefix,
  Config,
  sleep,
  getBuffer,
  smdJson,
  smdBuffer
} = require('../lib');

const axios = require('axios');
const yts = require('yt-search');

smd({
  cmdname: "video2",
  alias: ["ytv2", "ytvideo2"],
  desc: "Play YouTube video using yt-search and download via API",
  type: "downloader",
  filename: __filename,
},
async (m) => {
  try {
    let text = m.body.split(" ").slice(1).join(" ").trim();

    if (!text) return m.reply("*ğŸ¬ Provide a video name to search!*\nExample: `.video2 tu hai kahan`");

    // 1. Search video on YouTube
    const search = await yts(text);
    const video = search.videos[0];

    if (!video) return m.reply("âŒ No video found for that query.");

    const videoUrl = video.url;
    const api = `https://exonity.tech/api/ytdl-download?url=${encodeURIComponent(videoUrl)}&type=video`;

    // 2. Get download link from API
    const res = await axios.get(api);
    const json = res.data;

    if (!json.status || !json.data?.url) {
      return m.reply("âŒ Failed to fetch video. Try again.");
    }

    const { title, uploader, duration, thumbnail, url } = json.data;
    const caption = `ğŸï¸ *${title}*\nğŸ‘¤ Uploader: ${uploader}\nâ± Duration: ${duration}`;

    await m.send(url, { caption, thumbnail }, "video", m);

  } catch (e) {
    m.error(`${e}\n\nCommand: video2`, e, false);
  }
});
